<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="shortcut icon" href="https://dustindnguyen.github.io/images/favicon.png" />
<title>Controlled Neural ODE | Dustin Nguyen</title>
<meta name="title" content="Controlled Neural ODE" />
<meta name="description" content="Sample article showcasing basic Markdown syntax and formatting for HTML elements." />
<meta name="keywords" content="SciML,NeuralODE,TimeSeries," />


<meta property="og:url" content="https://dustindnguyen.github.io/controlled-neural-ode/">
  <meta property="og:site_name" content="Dustin Nguyen">
  <meta property="og:title" content="Controlled Neural ODE">
  <meta property="og:description" content="Sample article showcasing basic Markdown syntax and formatting for HTML elements.">
  <meta property="og:locale" content="en_US">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2025-03-01T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-03-01T00:00:00+00:00">
    <meta property="article:tag" content="SciML">
    <meta property="article:tag" content="NeuralODE">
    <meta property="article:tag" content="TimeSeries">
    <meta property="og:image" content="https://dustindnguyen.github.io/images/share.png">




  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://dustindnguyen.github.io/images/share.png">
  <meta name="twitter:title" content="Controlled Neural ODE">
  <meta name="twitter:description" content="Sample article showcasing basic Markdown syntax and formatting for HTML elements.">




  <meta itemprop="name" content="Controlled Neural ODE">
  <meta itemprop="description" content="Sample article showcasing basic Markdown syntax and formatting for HTML elements.">
  <meta itemprop="datePublished" content="2025-03-01T00:00:00+00:00">
  <meta itemprop="dateModified" content="2025-03-01T00:00:00+00:00">
  <meta itemprop="wordCount" content="740">
  <meta itemprop="image" content="https://dustindnguyen.github.io/images/share.png">
  <meta itemprop="keywords" content="SciML,NeuralODE,TimeSeries">
<meta name="referrer" content="no-referrer-when-downgrade" />

  <style>
  :root {
    --width: 720px;
    --font-main: Verdana, sans-serif;
    --font-secondary: Verdana, sans-serif;
    --font-scale: 1em;
    --background-color: #fff;
    --heading-color: #222;
    --text-color: #444;
    --link-color: #3273dc;
    --visited-color: #8b6fcb;
    --blockquote-color: #222;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --background-color: #01242e;
      --heading-color: #eee;
      --text-color: #ddd;
      --link-color: #8cc2dd;
      --visited-color: #8b6fcb;
      --blockquote-color: #ccc;
    }
  }

  body {
    font-family: var(--font-secondary);
    font-size: var(--font-scale);
    margin: auto;
    padding: 20px;
    max-width: var(--width);
    text-align: left;
    background-color: var(--background-color);
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.5;
    color: var(--text-color);
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    font-family: var(--font-main);
    color: var(--heading-color);
  }

  a {
    color: var(--link-color);
    cursor: pointer;
    text-decoration: none;
  }

  a:hover {
    text-decoration: underline;
  }

  nav a {
    margin-right: 8px;
  }

  strong,
  b {
    color: var(--heading-color);
  }

  button {
    margin: 0;
    cursor: pointer;
  }

  time {
    font-family: monospace;
    font-style: normal;
    font-size: 15px;
  }

  main {
    line-height: 1.6;
  }

  table {
    width: 100%;
  }

  hr {
    border: 0;
    border-top: 1px dashed;
  }

  img {
    max-width: 100%;
  }

  code {
    font-family: monospace;
    padding: 2px;
    border-radius: 3px;
  }

  blockquote {
    border-left: 1px solid #999;
    color: var(--blockquote-color);
    padding-left: 20px;
    font-style: italic;
  }

  footer {
    padding: 25px 0;
    text-align: center;
  }

  .title:hover {
    text-decoration: none;
  }

  .title h1 {
    font-size: 1.5em;
  }

  .inline {
    width: auto !important;
  }

  .highlight,
  .code {
    border-radius: 3px;
    margin-block-start: 1em;
    margin-block-end: 1em;
    overflow-x: auto;
  }

   
  ul.blog-posts {
    list-style-type: none;
    padding: unset;
  }

  ul.blog-posts li {
    display: flex;
  }

  ul.blog-posts li span {
    flex: 0 0 130px;
  }

  ul.blog-posts li a:visited {
    color: var(--visited-color);
  }

</style>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false}
          ],
          throwOnError : false
        });
    });
</script>


</head>

<body>
  <header><a href="/" class="title">
  <h2>Dustin Nguyen</h2>
</a>
<nav>
<a href="/">Home</a>

<a href="/resume/">Resume</a>

<a href="/blog/">Blog</a>

</nav>
</header>
  <main>

<h1>Controlled Neural ODE</h1>
<p>
  <i>
    <time datetime='2025-03-01'>
      01 Mar, 2025
    </time>
  </i>
</p>

<content>
  <p>In this <a href="https://github.com/dustindnguyen/2024_Neural_ODE_Forced_Harmonic_Oscillator">repo</a> I showcase a simple application of Controlled Neural ODEs as a surrogate model of a physical system. In this case, it is the Forced-and-Damped Simple Harmonic Oscillator.</p>
<p><strong>A brief recap on Neural ODEs</strong>:</p>
<p>A Controlled ODE describes the rate of change of a state (vector) as:</p>
<p>$$
dy = f(y, t, u) \ dt
$$</p>
<p>where $f(y, t, u)$ is a function that takes in state $y$, time $t$, and non-state variables $u$. In this case, $u$ are external controls. A Neural ODE replaces analytic function $f$ with a neural network $f_{NN}$ either partially, or entirely. The motivation for replacing some or all of existing analytic functions is: 1. The analytical function is computationally expensive (e.g., requires integrals or is very detailed), or 2. The analytic function is not known and can be learned from the data.</p>
<p>A Neural ODE can be interpretted as the continuos analog of a Residual Neural Network. A Controlled Neural ODE is not the same architecture as a Neural Control Differential Equation (Neural CDE), which is the continuous analog of a Recurrent Neural Network (RNN). A Controlled Neural ODE does not require external control paths (i.e., interpolations) as a Neural CDE does.</p>
<p><strong>A brief recap on the physical system</strong>:</p>
<p>The simple harmonic oscillator describes the acceleration of a mass on a spring as:</p>
<p>$$
F_\mathrm{net} = ma \quad \rightarrow \quad \frac{dx^2}{dt^2} = - \frac{kx - cv + u}{m}
$$</p>
<p>where $m$ is the mass, $k$ is the spring constant, $c$ is the damping coefficient, and $u$ is the forcing function (input controls). This second order differential equation can be broken down into two first order differential equations as</p>
<p>$$
\frac{dx}{dt} = v \quad \mathrm{and} \quad \frac{dv}{dt} = - \frac{kx - cv + u}{m}
$$</p>
<p>Defining the rate-of-change of position as velocity can be done in PyTorch as</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">MassSpringDamperDynamics</span>(nn<span style="color:#666">.</span>Module):
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">__init__</span>(<span style="color:#007020">self</span>, mass<span style="color:#666">=</span><span style="color:#40a070">1.0</span>, spring_k<span style="color:#666">=</span><span style="color:#40a070">2.0</span>, damping_c<span style="color:#666">=</span><span style="color:#40a070">0.5</span>):
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>        <span style="color:#007020">super</span>()<span style="color:#666">.</span><span style="color:#06287e">__init__</span>()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>        <span style="color:#007020">self</span><span style="color:#666">.</span>m <span style="color:#666">=</span> mass
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>        <span style="color:#007020">self</span><span style="color:#666">.</span>k <span style="color:#666">=</span> spring_k
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>        <span style="color:#007020">self</span><span style="color:#666">.</span>c <span style="color:#666">=</span> damping_c
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>        
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">forward</span>(<span style="color:#007020">self</span>, t, y, u):
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>        x <span style="color:#666">=</span> y[<span style="color:#666">...</span>, <span style="color:#40a070">0</span>:<span style="color:#40a070">1</span>]   
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>        v <span style="color:#666">=</span> y[<span style="color:#666">...</span>, <span style="color:#40a070">1</span>:<span style="color:#40a070">2</span>]   
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>        dx_dt <span style="color:#666">=</span> v         
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>        dv_dt <span style="color:#666">=</span> (<span style="color:#666">-</span><span style="color:#007020">self</span><span style="color:#666">.</span>k <span style="color:#666">*</span> x <span style="color:#666">-</span> <span style="color:#007020">self</span><span style="color:#666">.</span>c <span style="color:#666">*</span> v <span style="color:#666">+</span> u) <span style="color:#666">/</span> <span style="color:#007020">self</span><span style="color:#666">.</span>m  
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>        <span style="color:#007020;font-weight:bold">return</span> torch<span style="color:#666">.</span>cat([dx_dt, dv_dt], dim<span style="color:#666">=-</span><span style="color:#40a070">1</span>)
</span></span></code></pre></div><p>Below is an animation of one mass with certain initial conditions ($x_0$, $y_0$) and physical parameters ($m$, $k$, $c$) undergoing its $t_f = 5$ second trajectory.</p>
<p><img src="/blog/neural_ode/single_mass_spring.gif" alt="single_mass_spring"></p>
<p>The arrow represents the forced input $u(t)$ and the x-axis is the displacement from equillibrium. With additional code, we can use this defined physical system to generate a batch of trajectories with different initial conditions ($x_0$, $y_0$) and different physics parameters ($m$, $k$, $c$).</p>
<p>This data will be the truth from which our neural model attempts to learn dynamics from. We will train on the entire batch of trajectories, leveraging PyTorch-based torchdiffeq package which can integrate a batch of initial conditions forward in time - in parallel. Below are an example of first 5 trajectories animated in space over time.</p>
<p><img src="/blog/neural_ode/five_mass_spring.gif" alt="five_mass_spring"></p>
<p>The Controlled Neural ODE in PyTorch looks like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">ControlledNeuralODEFunc</span>(nn<span style="color:#666">.</span>Module):
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">__init__</span>(<span style="color:#007020">self</span>, hidden_dim<span style="color:#666">=</span><span style="color:#40a070">16</span>):
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>        <span style="color:#007020">super</span>()<span style="color:#666">.</span><span style="color:#06287e">__init__</span>()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>        <span style="color:#007020">self</span><span style="color:#666">.</span>acc_net <span style="color:#666">=</span> nn<span style="color:#666">.</span>Sequential(
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>            nn<span style="color:#666">.</span>Linear(<span style="color:#40a070">3</span>, hidden_dim),
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>            nn<span style="color:#666">.</span>Tanh(),
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>            nn<span style="color:#666">.</span>Linear(hidden_dim, hidden_dim),
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>            nn<span style="color:#666">.</span>Tanh(),
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>            nn<span style="color:#666">.</span>Linear(hidden_dim, <span style="color:#40a070">1</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>        )
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>        last_layer <span style="color:#666">=</span> <span style="color:#007020">self</span><span style="color:#666">.</span>acc_net[<span style="color:#666">-</span><span style="color:#40a070">1</span>]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>        nn<span style="color:#666">.</span>init<span style="color:#666">.</span>uniform_(last_layer<span style="color:#666">.</span>weight,<span style="color:#666">-</span><span style="color:#40a070">1e-7</span>,<span style="color:#40a070">1e-7</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>        <span style="color:#007020">self</span><span style="color:#666">.</span>control <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">None</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>        <span style="color:#007020">self</span><span style="color:#666">.</span>dt <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">None</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>        
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">forward</span>(<span style="color:#007020">self</span>, t, y):
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>        x <span style="color:#666">=</span> y[<span style="color:#666">...</span>, <span style="color:#40a070">0</span>:<span style="color:#40a070">1</span>]             
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>        v <span style="color:#666">=</span> y[<span style="color:#666">...</span>, <span style="color:#40a070">1</span>:<span style="color:#40a070">2</span>]          
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>        u <span style="color:#666">=</span> interpolate_control(t, <span style="color:#007020">self</span><span style="color:#666">.</span>control, <span style="color:#007020">self</span><span style="color:#666">.</span>dt)<span style="color:#666">.</span>unsqueeze(<span style="color:#666">-</span><span style="color:#40a070">1</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>        
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>        xu <span style="color:#666">=</span> torch<span style="color:#666">.</span>cat([x, v, u], dim<span style="color:#666">=-</span><span style="color:#40a070">1</span>)  <span style="color:#60a0b0;font-style:italic"># [batch_size, 3]</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>        
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>        dx_dt <span style="color:#666">=</span> v
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>        dv_dt <span style="color:#666">=</span> <span style="color:#007020">self</span><span style="color:#666">.</span>acc_net(xu)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>        
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>        <span style="color:#007020;font-weight:bold">return</span> torch<span style="color:#666">.</span>cat([dx_dt, dv_dt], dim<span style="color:#666">=-</span><span style="color:#40a070">1</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">ControlledNeuralODE</span>(nn<span style="color:#666">.</span>Module):
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">__init__</span>(<span style="color:#007020">self</span>, func):
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>        <span style="color:#007020">super</span>()<span style="color:#666">.</span><span style="color:#06287e">__init__</span>()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>        <span style="color:#007020">self</span><span style="color:#666">.</span>func <span style="color:#666">=</span> func
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>        
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">forward</span>(<span style="color:#007020">self</span>, t_span, y0, control):
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>        <span style="color:#007020">self</span><span style="color:#666">.</span>func<span style="color:#666">.</span>control <span style="color:#666">=</span> control
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>        <span style="color:#007020">self</span><span style="color:#666">.</span>func<span style="color:#666">.</span>dt <span style="color:#666">=</span> <span style="color:#40a070">0.1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>        pred <span style="color:#666">=</span> odeint(<span style="color:#007020">self</span><span style="color:#666">.</span>func, y0, t_span, method<span style="color:#666">=</span><span style="color:#4070a0">&#39;rk4&#39;</span>, options<span style="color:#666">=</span>{<span style="color:#4070a0">&#39;step_size&#39;</span>: <span style="color:#007020">self</span><span style="color:#666">.</span>func<span style="color:#666">.</span>dt})
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>        <span style="color:#007020;font-weight:bold">return</span> pred<span style="color:#666">.</span>transpose(<span style="color:#40a070">0</span>, <span style="color:#40a070">1</span>)
</span></span></code></pre></div><p>The model is trained over 2000 epochs. Below is an animation of the training for the first three trajectories (all trajectories are trained at the same time, but here I show just three).</p>
<p><img src="/blog/neural_ode/ncode.gif" alt="training"></p>
<p>It is apparent that the neural network, when given input controls, is able to learn the dynamics enough to fit the training data. Here is a static comparison between the trained and untrained Neural ODEs.</p>
<p><img src="/blog/neural_ode/before_after.png" alt="before_after"></p>
<p>In this example, we utilized the neural network within the Neural ODE to learn the entire right hand side of the differential equation. However, if we know existing physics, it would be straightforward to incorporate it in the <code>ControlledNeuralODEFunc</code> class above.</p>

</content>



<p>
  
  <a href="https://dustindnguyen.github.io/blog/sciml/">#SciML</a>
  
  <a href="https://dustindnguyen.github.io/blog/neuralode/">#NeuralODE</a>
  
  <a href="https://dustindnguyen.github.io/blog/timeseries/">#TimeSeries</a>
  
</p>

  </main>
  <footer>Made with <a href="https://github.com/janraasch/hugo-bearblog/">Hugo ʕ•ᴥ•ʔ Bear</a>
</footer>

  
</body>

</html>
